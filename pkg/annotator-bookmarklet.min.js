(function(){var h,n,b,o,i,l,a,e,d,c,p,r,j;var m=Array.prototype.slice,g=function(s,t){return function(){return s.apply(t,arguments)}},k=Object.prototype.hasOwnProperty,q=function(v,t){for(var s in t){if(k.call(t,s)){v[s]=t[s]}}function u(){this.constructor=v}u.prototype=t.prototype;v.prototype=new u;v.__super__=t.prototype;return v},f=Array.prototype.indexOf||function(u){for(var t=0,s=this.length;t<s;t++){if(this[t]===u){return t}}return -1};if(!(typeof jQuery!=="undefined"&&jQuery!==null?(j=jQuery.fn)!=null?j.jquery:void 0:void 0)){console.error("Annotator requires jQuery: have you included lib/vendor/jquery.js?")}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")}h=jQuery.sub();h.flatten=function(t){var s;s=function(v){var w,y,x,u;y=[];for(x=0,u=v.length;x<u;x++){w=v[x];y=y.concat(w&&h.isArray(w)?s(w):w)}return y};return s(t)};h.plugin=function(t,s){return jQuery.fn[t]=function(v){var u;u=Array.prototype.slice.call(arguments,1);return this.each(function(){var w;w=h.data(this,t);if(w){return v&&w[v].apply(w,u)}else{w=new s(this,v);return h.data(this,t,w)}})}};h.fn.textNodes=function(){var s;s=function(u){var t;if(u&&u.nodeType!==3){t=[];if(u.nodeType!==8){u=u.lastChild;while(u){t.push(s(u));u=u.previousSibling}}return t.reverse()}else{return u}};return this.map(function(){return h.flatten(s(this))})};h.fn.xpath=function(s){var t;t=this.map(function(){var v,u,w;w="";v=this;while(v&&v.nodeType===1&&v!==s){u=h(v.parentNode).children(v.tagName).index(v)+1;u=u>1?"["+u+"]":"";w="/"+v.tagName.toLowerCase()+u+w;v=v.parentNode}return w});return t.get()};h.escape=function(s){return s.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};h.fn.escape=function(s){if(arguments.length){return this.html(h.escape(s))}return this.html()};l=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!=="undefined"&&console!==null){if(!(console.group!=null)){console.group=function(s){return console.log("GROUP: ",s)}}if(!(console.groupCollapsed!=null)){console.groupCollapsed=console.group}for(d=0,p=l.length;d<p;d++){i=l[d];if(!(console[i]!=null)){console[i]=function(){return console.log("Not implemented: console."+name)}}}}else{this.console={};for(c=0,r=l.length;c<r;c++){i=l[c];this.console[i]=function(){}}this.console.error=function(){var s;s=1<=arguments.length?m.call(arguments,0):[];return alert("ERROR: "+(s.join(", ")))};this.console.warn=function(){var s;s=1<=arguments.length?m.call(arguments,0):[];return alert("WARNING: "+(s.join(", ")))}}b=(function(){s.prototype.events={};s.prototype.options={};s.prototype.element=null;function s(u,t){this.options=h.extend(true,{},this.options,t);this.element=h(u);this.on=this.subscribe;this.addEvents()}s.prototype.addEvents=function(){var w,y,x,t,v,A,z,u;A=this.events;u=[];for(x in A){y=A[x];z=x.split(" "),t=2<=z.length?m.call(z,0,v=z.length-1):(v=0,[]),w=z[v++];u.push(this.addEvent(t.join(" "),w,y))}return u};s.prototype.addEvent=function(t,v,w){var x,u;x=g(function(){return this[w].apply(this,arguments)},this);u=typeof t==="string"&&t.replace(/\s+/g,"")==="";if(u){t=this.element}if(typeof t==="string"){this.element.delegate(t,v,x)}else{if(this.isCustomEvent(v)){this.subscribe(v,x)}else{h(t).bind(v,x)}}return this};s.prototype.isCustomEvent=function(u){var t;t="blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/);u=u.split(".")[0];return h.inArray(u,t)===-1};s.prototype.publish=function(){this.element.triggerHandler.apply(this.element,arguments);return this};s.prototype.subscribe=function(t,v){var u;u=function(){return v.apply(this,[].slice.call(arguments,1))};u.guid=v.guid=(h.guid+=1);this.element.bind(t,u);return this};s.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return s})();o={};o.sniff=function(s){if(s.commonAncestorContainer!=null){return new o.BrowserRange(s)}else{if(typeof s.start==="string"){return new o.SerializedRange(s)}else{if(s.start&&typeof s.start==="object"){return new o.NormalizedRange(s)}else{console.error("Couldn't not sniff range type");return false}}}};o.BrowserRange=(function(){function s(t){this.commonAncestorContainer=t.commonAncestorContainer;this.startContainer=t.startContainer;this.startOffset=t.startOffset;this.endContainer=t.endContainer;this.endOffset=t.endOffset}s.prototype.normalize=function(B){var A,w,C,z,v,u,y,t,x;if(this.tainted){console.error("You may only call normalize() once on a BrowserRange!");return false}else{this.tainted=true}u={};C={};x=["start","end"];for(y=0,t=x.length;y<t;y++){v=x[y];w=this[v+"Container"];z=this[v+"Offset"];if(w.nodeType===1){A=w.childNodes[z];w=A||w.childNodes[z-1];while(w.nodeType!==3){w=w.firstChild}z=A?0:w.nodeValue.length}u[v]=w;u[v+"Offset"]=z}C.start=u.startOffset>0?u.start.splitText(u.startOffset):u.start;if(u.start===u.end){if((u.endOffset-u.startOffset)<C.start.nodeValue.length){C.start.splitText(u.endOffset-u.startOffset)}C.end=C.start}else{if(u.endOffset<u.end.nodeValue.length){u.end.splitText(u.endOffset)}C.end=u.end}C.commonAncestor=this.commonAncestorContainer;while(C.commonAncestor.nodeType!==1){C.commonAncestor=C.commonAncestor.parentNode}return new o.NormalizedRange(C)};s.prototype.serialize=function(t,u){return this.normalize(t).serialize(t,u)};return s})();o.NormalizedRange=(function(){function s(t){this.commonAncestor=t.commonAncestor;this.start=t.start;this.end=t.end}s.prototype.normalize=function(t){return this};s.prototype.limit=function(x){var t,w,u,v,z,y;t=h.grep(this.textNodes(),function(A){return A.parentNode===x||h.contains(x,A.parentNode)});if(!t.length){return null}this.start=t[0];this.end=t[t.length-1];u=h(this.start).parents();y=h(this.end).parents();for(v=0,z=y.length;v<z;v++){w=y[v];if(u.index(w)!==-1){this.commonAncestor=w;break}}return this};s.prototype.serialize=function(v,w){var u,t,x;t=function(C,B){var A,z,E,H,G,F,D,y;if(w){H=h(C).parents(":not("+w+")").eq(0)}else{H=h(C).parent()}F=H.xpath(v)[0];G=H.textNodes();z=G.slice(0,G.index(C));E=0;for(D=0,y=z.length;D<y;D++){A=z[D];E+=A.nodeValue.length}if(B){return[F,E+C.nodeValue.length]}else{return[F,E]}};x=t(this.start);u=t(this.end,true);return new o.SerializedRange({start:x[0],end:u[0],startOffset:x[1],endOffset:u[1]})};s.prototype.text=function(){var t;return((function(){var v,x,w,u;w=this.textNodes();u=[];for(v=0,x=w.length;v<x;v++){t=w[v];u.push(t.nodeValue)}return u}).call(this)).join("")};s.prototype.textNodes=function(){var t,w,u,v;u=h(this.commonAncestor).textNodes();v=[u.index(this.start),u.index(this.end)],w=v[0],t=v[1];return h.makeArray(u.slice(w,(t+1)||9000000000))};return s})();o.SerializedRange=(function(){function s(t){this.start=t.start;this.startOffset=t.startOffset;this.end=t.end;this.endOffset=t.endOffset}s.prototype._nodeFromXPath=function(t){var y,x,u,w,v;x=function(A,z){if(z==null){z=null}return document.evaluate(A,document,z,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue};if(!h.isXMLDoc(document.documentElement)){return x(t)}else{y=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement);w=x(t,y);if(!w){t=((function(){var A,C,B,z;B=t.split("/");z=[];for(A=0,C=B.length;A<C;A++){v=B[A];z.push(v&&v.indexOf(":")===-1?v.replace(/^([a-z]+)/,"xhtml:$1"):v)}return z})()).join("/");u=document.lookupNamespaceURI(null);y=function(z){if(z==="xhtml"){return u}else{return document.documentElement.getAttribute("xmlns:"+z)}};w=x(t,y)}return w}};s.prototype.normalize=function(F){var J,C,B,H,z,E,G,D,A,y,u,t,K,I,x,w,v;G=h(F).xpath()[0];A=this.start.split("/");B=this.end.split("/");C=[];D={};for(H=0,x=A.length;0<=x?H<x:H>x;0<=x?H++:H--){if(A[H]===B[H]){C.push(A[H])}else{break}}J=G+C.join("/");D.commonAncestorContainer=this._nodeFromXPath(J);if(!D.commonAncestorContainer){console.error("Error deserializing range: can't find XPath '"+J+"'. Is this the right document?");return null}w=["start","end"];for(u=0,K=w.length;u<K;u++){E=w[u];z=0;v=h(this._nodeFromXPath(G+this[E])).textNodes();for(t=0,I=v.length;t<I;t++){y=v[t];if(z+y.nodeValue.length>=this[E+"Offset"]){D[E+"Container"]=y;D[E+"Offset"]=this[E+"Offset"]-z;break}else{z+=y.nodeValue.length}}}return new o.BrowserRange(D).normalize(F)};s.prototype.serialize=function(t,u){return this.normalize(t).serialize(t,u)};s.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return s})();a={getGlobal:function(){return(function(){return this})()},mousePosition:function(s,u){var t;t=h(u).offset();return{top:s.pageY-t.top,left:s.pageX-t.left}}};e=this.Annotator;n=(function(){q(s,b);s.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};s.prototype.html={hl:'<span class="annotator-hl"></span>',adder:'<div class="annotator-adder"><button>Annotate</button></div>',wrapper:'<div class="annotator-wrapper"></div>'};s.prototype.options={};s.prototype.plugins={};s.prototype.editor=null;s.prototype.viewer=null;s.prototype.selectedRanges=null;s.prototype.mouseIsDown=false;s.prototype.ignoreMouseup=false;s.prototype.viewerHideTimer=null;function s(v,u){this.onDeleteAnnotation=g(this.onDeleteAnnotation,this);this.onEditAnnotation=g(this.onEditAnnotation,this);this.onAdderClick=g(this.onAdderClick,this);this.onAdderMousedown=g(this.onAdderMousedown,this);this.onHighlightMouseover=g(this.onHighlightMouseover,this);this.checkForEndSelection=g(this.checkForEndSelection,this);this.checkForStartSelection=g(this.checkForStartSelection,this);this.clearViewerHideTimer=g(this.clearViewerHideTimer,this);this.startViewerHideTimer=g(this.startViewerHideTimer,this);this.showViewer=g(this.showViewer,this);this.onEditorSubmit=g(this.onEditorSubmit,this);this.onEditorHide=g(this.onEditorHide,this);this.showEditor=g(this.showEditor,this);var t,w,x;s.__super__.constructor.apply(this,arguments);this.plugins={};if(!s.supported()){return this}this._setupDocumentEvents()._setupWrapper()._setupViewer()._setupEditor();x=this.html;for(t in x){w=x[t];if(t!=="wrapper"){this[t]=h(w).appendTo(this.wrapper).hide()}}}s.prototype._setupWrapper=function(){this.wrapper=h(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");return this};s.prototype._setupViewer=function(){this.viewer=new s.Viewer();this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:g(function(u,t){h(u).escape(t.text||"");return this.publish("annotationViewerTextField",[u,t])},this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};s.prototype._setupEditor=function(){this.editor=new s.Editor();this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:"Comments\u2026",load:function(u,t){return h(u).find("textarea").val(t.text||"")},submit:function(u,t){return t.text=h(u).find("textarea").val()}});this.editor.element.appendTo(this.wrapper);return this};s.prototype._setupDocumentEvents=function(){h(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};s.prototype.getSelectedRanges=function(){var w,u,t,v;v=a.getGlobal().getSelection();t=[];if(!v.isCollapsed){t=(function(){var y,x;x=[];for(u=0,y=v.rangeCount;0<=y?u<y:u>y;0<=y?u++:u--){w=new o.BrowserRange(v.getRangeAt(u));x.push(w.normalize().limit(this.wrapper[0]))}return x}).call(this)}return h.grep(t,function(x){return x})};s.prototype.createAnnotation=function(){var t;t={};this.publish("beforeAnnotationCreated",[t]);return t};s.prototype.setupAnnotation=function(t,v){var u,z,y,w,x,A;if(v==null){v=true}t.ranges||(t.ranges=this.selectedRanges);z=(function(){var C,E,D,B;D=t.ranges;B=[];for(C=0,E=D.length;C<E;C++){y=D[C];w=o.sniff(y);B.push(w.normalize(this.wrapper[0]))}return B}).call(this);z=h.grep(z,function(B){return B!==null});t.quote=[];t.ranges=[];t.highlights=[];for(x=0,A=z.length;x<A;x++){u=z[x];t.quote.push(h.trim(u.text()));t.ranges.push(u.serialize(this.wrapper[0],".annotator-hl"));h.merge(t.highlights,this.highlightRange(u))}t.quote=t.quote.join(" / ");h(t.highlights).data("annotation",t);if(v){this.publish("annotationCreated",[t])}return t};s.prototype.updateAnnotation=function(t){this.publish("beforeAnnotationUpdated",[t]);this.publish("annotationUpdated",[t]);return t};s.prototype.deleteAnnotation=function(t){var v,u,x,w;w=t.highlights;for(u=0,x=w.length;u<x;u++){v=w[u];h(v).replaceWith(v.childNodes)}this.publish("annotationDeleted",[t]);return t};s.prototype.loadAnnotations=function(u){var v,t;if(u==null){u=[]}t=g(function(y){var A,w,x,z;if(y==null){y=[]}w=y.splice(0,10);for(x=0,z=w.length;x<z;x++){A=w[x];this.setupAnnotation(A,false)}if(y.length>0){return setTimeout((function(){return t(y)}),100)}else{return this.publish("annotationsLoaded",[v])}},this);v=u.slice();if(u.length){t(u)}return this};s.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{return console.warn("Can't dump annotations without Store plugin.")}};s.prototype.highlightRange=function(u){var t,v,w;return t=(function(){var y,A,z,x;z=u.textNodes();x=[];for(y=0,A=z.length;y<A;y++){v=z[y];w=this.hl.clone().show();x.push(h(v).wrap(w).parent().get(0))}return x}).call(this)};s.prototype.addPlugin=function(v,u){var t,w;if(this.plugins[v]){console.error("You cannot have more than one instance of any plugin.")}else{t=s.Plugin[v];if(typeof t==="function"){this.plugins[v]=new t(this.element[0],u);this.plugins[v].annotator=this;if(typeof(w=this.plugins[v]).pluginInit==="function"){w.pluginInit()}}else{console.error("Could not load "+v+" plugin. Have you included the appropriate <script> tag?")}}return this};s.prototype.showEditor=function(t,u){this.editor.element.css(u);this.editor.load(t);return this};s.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=false};s.prototype.onEditorSubmit=function(t){this.publish("annotationEditorSubmit",[this.editor,t]);if(t.ranges===void 0){return this.setupAnnotation(t)}else{return this.updateAnnotation(t)}};s.prototype.showViewer=function(u,t){this.viewer.element.css(t);this.viewer.load(u);return this.publish("annotationViewerShown",[this.viewer,u])};s.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout(h.proxy(this.viewer.hide,this.viewer),250)}};s.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};s.prototype.checkForStartSelection=function(t){if(!(t&&this.isAnnotator(t.target))){this.startViewerHideTimer();return this.mouseIsDown=true}};s.prototype.checkForEndSelection=function(w){var t,u,v,y,x;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.selectedRanges=this.getSelectedRanges();x=this.selectedRanges;for(v=0,y=x.length;v<y;v++){u=x[v];t=u.commonAncestor;if(this.isAnnotator(t)){return}}if(w&&this.selectedRanges.length){return this.adder.css(a.mousePosition(w,this.wrapper[0])).show()}else{return this.adder.hide()}};s.prototype.isAnnotator=function(t){return !!h(t).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length};s.prototype.onHighlightMouseover=function(t){var u;this.clearViewerHideTimer();if(this.mouseIsDown||this.viewer.isShown()){return false}u=h(t.target).parents(".annotator-hl").andSelf().map(function(){return h(this).data("annotation")});return this.showViewer(h.makeArray(u),a.mousePosition(t,this.wrapper[0]))};s.prototype.onAdderMousedown=function(t){if(t!=null){t.preventDefault()}return this.ignoreMouseup=true};s.prototype.onAdderClick=function(u){var t;if(u!=null){u.preventDefault()}t=this.adder.position();this.adder.hide();return this.showEditor(this.createAnnotation(),t)};s.prototype.onEditAnnotation=function(t){var u;u=this.viewer.element.position();this.viewer.hide();return this.showEditor(t,u)};s.prototype.onDeleteAnnotation=function(t){this.viewer.hide();return this.deleteAnnotation(t)};return s})();n.Plugin=(function(){q(s,b);function s(u,t){s.__super__.constructor.apply(this,arguments)}s.prototype.pluginInit=function(){};return s})();n.$=h;n.supported=function(){return(function(){return !!this.getSelection})()};n.noConflict=function(){a.getGlobal().Annotator=e;return this};h.plugin("annotator",n);this.Annotator=n;n.Widget=(function(){q(s,b);s.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};function s(u,t){s.__super__.constructor.apply(this,arguments);this.classes=h.extend({},n.Widget.prototype.classes,this.classes)}s.prototype.checkOrientation=function(){var w,x,t,v,u;this.resetOrientation();u=h(a.getGlobal());v=this.element.children(":first");x=v.offset();t={top:u.scrollTop(),right:u.width()+u.scrollLeft()};w={top:x.top,right:x.left+v.width()};if((w.top-t.top)<0){this.invertY()}if((w.right-t.right)>0){this.invertX()}return this};s.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};s.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};s.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};return s})();n.Editor=(function(){q(s,n.Widget);s.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};s.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};s.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">Cancel</a>\n      <a href="#save" class="annotator-save annotator-focus">Save</a>\n    </div>\n    <span class="annotator-resize"></span>\n  </form>\n</div>';s.prototype.options={};function s(t){this.onCancelButtonMouseover=g(this.onCancelButtonMouseover,this);this.processKeypress=g(this.processKeypress,this);this.submit=g(this.submit,this);this.load=g(this.load,this);this.hide=g(this.hide,this);this.show=g(this.show,this);s.__super__.constructor.call(this,h(this.html)[0],t);this.fields=[];this.annotation={};this.setupDragabbles()}s.prototype.show=function(t){if(t!=null){t.preventDefault()}this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.element.find(":input:first").focus();return this.checkOrientation().publish("show")};s.prototype.hide=function(t){if(t!=null){t.preventDefault()}this.element.addClass(this.classes.hide);return this.publish("hide")};s.prototype.load=function(t){var v,u,x,w;this.annotation=t;this.publish("load",[this.annotation]);w=this.fields;for(u=0,x=w.length;u<x;u++){v=w[u];v.load(v.element,this.annotation)}return this.show()};s.prototype.submit=function(u){var v,t,x,w;if(u!=null){u.preventDefault()}w=this.fields;for(t=0,x=w.length;t<x;t++){v=w[t];v.submit(v.element,this.annotation)}this.publish("save",[this.annotation]);return this.hide()};s.prototype.addField=function(u){var v,w,t;w=h.extend({id:"annotator-field-"+(new Date()).getTime(),type:"input",label:"",load:function(){},submit:function(){}},u);t=null;v=h('<li class="annotator-item" />');w.element=v[0];switch(w.type){case"textarea":t=h("<textarea />");break;case"input":case"checkbox":t=h("<input />")}v.append(t);t.attr({id:w.id,placeholder:w.label});if(w.type==="checkbox"){t[0].type="checkbox";v.addClass("annotator-checkbox");v.append(h("<label />",{"for":w.id,html:w.label}))}this.element.find("ul:first").append(v);this.fields.push(w);return w.element};s.prototype.checkOrientation=function(){var t,v,u;s.__super__.checkOrientation.apply(this,arguments);u=this.element.find("ul");t=this.element.find(".annotator-controls");v=function(){return u.children().each(function(){return h(this).parent().prepend(this)})};if(this.element.hasClass(this.classes.invert.y)&&u.is(":first-child")){t.insertBefore(u);v()}else{if(t.is(":first-child")){t.insertAfter(u);v()}}return this};s.prototype.processKeypress=function(t){if(t.keyCode===27){return this.hide()}else{if(t.keyCode===13&&!t.shiftKey){return this.submit()}}};s.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)};s.prototype.setupDragabbles=function(){var v,C,y,t,x,A,w,u,z,B;t=null;v=this.classes;y=this.element;z=null;u=y.find(".annotator-resize");C=y.find(".annotator-controls");B=false;x=function(D){if(D.target===this){t={element:this,top:D.pageY,left:D.pageX};z=y.find("textarea:first");h(window).bind({"mouseup.annotator-editor-resize":w,"mousemove.annotator-editor-resize":A});return D.preventDefault()}};w=function(){t=null;return h(window).unbind(".annotator-editor-resize")};A=g(function(H){var I,F,E,D,G;if(t&&B===false){I={top:H.pageY-t.top,left:H.pageX-t.left};if(t.element===u[0]){D=z.outerHeight();G=z.outerWidth();F=y.hasClass(v.invert.x)?-1:1;E=y.hasClass(v.invert.y)?1:-1;z.height(D+(I.top*E));z.width(G+(I.left*F));if(z.outerHeight()!==D){t.top=H.pageY}if(z.outerWidth()!==G){t.left=H.pageX}}else{if(t.element===C[0]){y.css({top:parseInt(y.css("top"),10)+I.top,left:parseInt(y.css("left"),10)+I.left});t.top=H.pageY;t.left=H.pageX}}B=true;return setTimeout(function(){return B=false},1000/60)}},this);u.bind("mousedown",x);return C.bind("mousedown",x)};return s})();n.Viewer=(function(){q(s,n.Widget);s.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};s.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};s.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <button class="annotator-edit">Edit</button>\n    <button class="annotator-delete">Delete</button>\n  </span>\n</li>'};function s(t){this.onDeleteClick=g(this.onDeleteClick,this);this.onEditClick=g(this.onEditClick,this);this.load=g(this.load,this);this.hide=g(this.hide,this);this.show=g(this.show,this);s.__super__.constructor.call(this,h(this.html.element)[0],t);this.item=h(this.html.item)[0];this.fields=[];this.annotations=[]}s.prototype.show=function(u){var t;if(u!=null){u.preventDefault()}t=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout((g(function(){return t.removeClass(this.classes.showControls)},this)),500);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};s.prototype.isShown=function(){return !this.element.hasClass(this.classes.hide)};s.prototype.hide=function(t){if(t!=null){t.preventDefault()}this.element.addClass(this.classes.hide);return this.publish("hide")};s.prototype.load=function(B){var y,A,F,G,E,z,D,H,C,x,v,t,I,w,u;this.annotations=B||[];C=this.element.find("ul:first").empty();w=this.annotations;for(x=0,t=w.length;x<t;x++){y=w[x];H=h(this.item).clone().appendTo(C).data("annotation",y);F=H.find(".annotator-controls");E=F.find(".annotator-edit");G=F.find(".annotator-delete");A={showEdit:function(){return E.removeAttr("disabled")},hideEdit:function(){return E.attr("disabled","disabled")},showDelete:function(){return G.removeAttr("disabled")},hideDelete:function(){return G.attr("disabled","disabled")}};u=this.fields;for(v=0,I=u.length;v<I;v++){D=u[v];z=h(D.element).clone().appendTo(H)[0];D.load(z,y,A)}}this.publish("load",[this.annotations]);return this.show()};s.prototype.addField=function(t){var u;u=h.extend({load:function(){}},t);u.element=h("<div />")[0];this.fields.push(u);u.element;return this};s.prototype.onEditClick=function(t){return this.onButtonClick(t,"edit")};s.prototype.onDeleteClick=function(t){return this.onButtonClick(t,"delete")};s.prototype.onButtonClick=function(v,t){var u;u=h(v.target).parents(".annotator-annotation");return this.publish(t,[u.data("annotation")])};return s})();n=n||{};n.Notification=(function(){q(s,b);s.prototype.events={click:"hide"};s.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};function s(t){this.hide=g(this.hide,this);this.show=g(this.show,this);s.__super__.constructor.call(this,h(this.options.html).appendTo(document.body)[0],t)}s.prototype.show=function(u,t){if(t==null){t=n.Notification.INFO}h(this.element).addClass(this.options.classes.show).addClass(this.options.classes[t]).escape(u||"");setTimeout(this.hide,5000);return this};s.prototype.hide=function(){h(this.element).removeClass(this.options.classes.show);return this};return s})();n.Notification.INFO="show";n.Notification.SUCCESS="success";n.Notification.ERROR="error";h(function(){var s;s=new n.Notification;n.showNotification=s.show;return n.hideNotification=s.hide});n.Plugin.Store=(function(){q(s,n.Plugin);s.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"};s.prototype.options={prefix:"/store",autoFetch:true,annotationData:{},loadFromSearch:false,urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}};function s(u,t){this._onError=g(this._onError,this);this._onBeforeSend=g(this._onBeforeSend,this);this._onLoadAnnotationsFromSearch=g(this._onLoadAnnotationsFromSearch,this);this._onLoadAnnotations=g(this._onLoadAnnotations,this);this._getAnnotations=g(this._getAnnotations,this);s.__super__.constructor.apply(this,arguments);this.annotations=[]}s.prototype.pluginInit=function(){var t;if(!n.supported()){return}t=this.element.data("annotator:auth");if(t){return t.withToken(this._getAnnotations)}else{return this._getAnnotations()}};s.prototype._getAnnotations=function(){if(this.options.loadFromSearch){return this.loadAnnotationsFromSearch(this.options.loadFromSearch)}else{return this.loadAnnotations()}};s.prototype.annotationCreated=function(t){if(f.call(this.annotations,t)<0){this.registerAnnotation(t);return this._apiRequest("create",t,g(function(u){if(!(u.id!=null)){console.warn("Warning: No ID returned from server for annotation ",t)}return this.updateAnnotation(t,u)},this))}else{return this.updateAnnotation(t,{})}};s.prototype.annotationUpdated=function(t){if(f.call(this.annotations,t)>=0){return this._apiRequest("update",t,(g(function(u){return this.updateAnnotation(t,u)},this)))}};s.prototype.annotationDeleted=function(t){if(f.call(this.annotations,t)>=0){return this._apiRequest("destroy",t,(g(function(){return this.unregisterAnnotation(t)},this)))}};s.prototype.registerAnnotation=function(t){return this.annotations.push(t)};s.prototype.unregisterAnnotation=function(t){return this.annotations.splice(this.annotations.indexOf(t),1)};s.prototype.updateAnnotation=function(t,u){if(f.call(this.annotations,t)<0){console.error("Trying to update unregistered annotation!")}else{h.extend(t,u)}return h(t.highlights).data("annotation",t)};s.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)};s.prototype._onLoadAnnotations=function(t){if(t==null){t=[]}this.annotations=t;return this.annotator.loadAnnotations(t.slice())};s.prototype.loadAnnotationsFromSearch=function(t){return this._apiRequest("search",t,this._onLoadAnnotationsFromSearch)};s.prototype._onLoadAnnotationsFromSearch=function(t){if(t==null){t={}}return this._onLoadAnnotations(t.rows||[])};s.prototype.dumpAnnotations=function(){var v,u,x,w,t;w=this.annotations;t=[];for(u=0,x=w.length;u<x;u++){v=w[u];t.push(JSON.parse(this._dataFor(v)))}return t};s.prototype._apiRequest=function(w,x,y){var z,u,v,t;z=x&&x.id;t=this._urlFor(w,z);u=this._apiRequestOptions(w,x,y);v=h.ajax(t,u);v._id=z;v._action=w;return v};s.prototype._apiRequestOptions=function(u,v,w){var t;t={type:this._methodFor(u),beforeSend:this._onBeforeSend,dataType:"json",success:w||function(){},error:this._onError};if(u==="search"){t=h.extend(t,{data:v})}else{t=h.extend(t,{data:v&&this._dataFor(v),contentType:"application/json; charset=utf-8"})}return t};s.prototype._urlFor=function(v,w){var t,u;t=w!=null?"/"+w:"";u=this.options.prefix||"/";u+=this.options.urls[v];u=u.replace(/\/:id/,t);return u};s.prototype._methodFor=function(u){var t;t={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"};return t[u]};s.prototype._dataFor=function(t){var u,v;v=t.highlights;delete t.highlights;h.extend(t,this.options.annotationData);u=JSON.stringify(t);if(v){t.highlights=v}return u};s.prototype._onBeforeSend=function(x){var w,u,v,t;w=this.element.data("annotator:headers");if(w){t=[];for(u in w){v=w[u];t.push(x.setRequestHeader(u,v))}return t}};s.prototype._onError=function(v){var u,t;u=v._action;t="Sorry we could not "+u+" this annotation";if(v._action==="search"){t="Sorry we could not search the store for annotations"}else{if(v._action==="read"&&!v._id){t="Sorry we could not "+u+" the annotations from the store"}}switch(v.status){case 401:t="Sorry you are not allowed to "+u+" this annotation";break;case 404:t="Sorry we could not connect to the annotations store";break;case 500:t="Sorry something went wrong with the annotation store"}n.showNotification(t,n.Notification.ERROR);return console.error("API request failed: '"+v.status+"'")};return s})();n.Plugin.Permissions=(function(){q(s,n.Plugin);s.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"};s.prototype.options={showViewPermissionsCheckbox:true,showEditPermissionsCheckbox:true,userId:function(t){return t},userString:function(t){return t},userAuthorize:function(t,u){return this.userId(t)===u},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}};function s(u,t){this.updateViewer=g(this.updateViewer,this);this.updateAnnotationPermissions=g(this.updateAnnotationPermissions,this);this.updatePermissionsField=g(this.updatePermissionsField,this);this.addFieldsToAnnotation=g(this.addFieldsToAnnotation,this);s.__super__.constructor.apply(this,arguments);if(this.options.user){this.setUser(this.options.user);delete this.options.user}}s.prototype.pluginInit=function(){var t,u;if(!n.supported()){return}u=this;t=function(w,v){return function(y,x){return u[w].call(u,v,y,x)}};if(this.options.showViewPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:"Allow anyone to <strong>view</strong> this annotation",load:t("updatePermissionsField","read"),submit:t("updateAnnotationPermissions","read")})}if(this.options.showEditPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:"Allow anyone to <strong>edit</strong> this annotation",load:t("updatePermissionsField","update"),submit:t("updateAnnotationPermissions","update")})}this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){return this.annotator.plugins.Filter.addFilter({label:"User",property:"user",isFiltered:g(function(x,w){var v,y,A,z;w=this.options.userString(w);if(!(x&&w)){return false}z=x.split(/\s*/);for(y=0,A=z.length;y<A;y++){v=z[y];if(w.indexOf(v)===-1){return false}}return true},this)})}};s.prototype.setUser=function(t){return this.user=t};s.prototype.addFieldsToAnnotation=function(t){if(t){t.permissions=this.options.permissions;if(this.user){return t.user=this.user}}};s.prototype.authorize=function(x,t,u){var v,y,w,z;if(u===void 0){u=this.user}if(t.permissions){y=t.permissions[x]||[];if(y.length===0){return true}for(w=0,z=y.length;w<z;w++){v=y[w];if(this.options.userAuthorize.call(this.options,u,v)){return true}}return false}else{if(t.user){return u&&this.options.userId(u)===t.user}}return true};s.prototype.updatePermissionsField=function(v,x,t){var w,u;x=h(x).show();u=x.find("input").removeAttr("disabled");if(!this.authorize("admin",t)){x.hide()}if(this.authorize(v,t||{},null)){u.attr("checked","checked");w={permissions:this.options.permissions};if(this.authorize(v,w,null)){return u.attr("disabled","disabled")}}else{return u.removeAttr("checked")}};s.prototype.updateAnnotationPermissions=function(v,w,t){var x,u;if(!t.permissions){t.permissions=this.options.permissions}x=v+"-permissions";if(h(w).find("input").is(":checked")){h.data(t,x,t.permissions[v]);return t.permissions[v]=[]}else{u=h.data(t,x);if(u){return t.permissions[v]=u}}};s.prototype.updateViewer=function(w,t,v){var u,x;w=h(w);x=this.options.userString(t.user);if(t.user&&x&&typeof x==="string"){u=n.$.escape(this.options.userString(t.user));w.html(u).addClass("annotator-user")}else{w.remove()}if(t.permissions){if(!this.authorize("update",t)){v.hideEdit()}if(!this.authorize("delete",t)){return v.hideDelete()}}else{if(t.user&&!this.authorize(null,t)){v.hideEdit();return v.hideDelete()}}};return s})();n.Plugin.Unsupported=(function(){q(s,n.Plugin);function s(){s.__super__.constructor.apply(this,arguments)}s.prototype.options={message:"Sorry your current browser does not support the Annotator"};s.prototype.pluginInit=function(){if(!n.supported()){return h(g(function(){n.showNotification(this.options.message);if((window.XMLHttpRequest===void 0)&&(ActiveXObject!==void 0)){return h("html").addClass("ie6")}},this))}};return s})();n.Plugin.Tags=(function(){q(s,n.Plugin);function s(){this.setAnnotationTags=g(this.setAnnotationTags,this);this.updateField=g(this.updateField,this);s.__super__.constructor.apply(this,arguments)}s.prototype.field=null;s.prototype.input=null;s.prototype.pluginInit=function(){if(!n.supported()){return}this.field=this.annotator.editor.addField({label:"Add some tags here\u2026",load:this.updateField,submit:this.setAnnotationTags});this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){this.annotator.plugins.Filter.addFilter({label:"Tag",property:"tags",isFiltered:n.Plugin.Tags.filterCallback})}return this.input=h(this.field).find(":input")};s.prototype.parseTags=function(u){var t;u=h.trim(u);t=[];if(u){t=u.split(/\s+/)}return t};s.prototype.stringifyTags=function(t){return t.join(" ")};s.prototype.updateField=function(v,t){var u;u="";if(t.tags){u=this.stringifyTags(t.tags)}return this.input.val(u)};s.prototype.setAnnotationTags=function(u,t){return t.tags=this.parseTags(this.input.val())};s.prototype.updateViewer=function(u,t){u=h(u);if(t.tags&&h.isArray(t.tags)&&t.tags.length){return u.addClass("annotator-tags").html(function(){var v;return v=h.map(t.tags,function(w){return'<span class="annotator-tag">'+n.$.escape(w)+"</span>"}).join(" ")})}else{return u.remove()}};return s})();n.Plugin.Tags.filterCallback=function(y,A){var x,w,v,B,u,t,s,z;if(A==null){A=[]}v=0;w=[];if(y){w=y.split(/\s+/g);for(u=0,s=w.length;u<s;u++){x=w[u];if(A.length){for(t=0,z=A.length;t<z;t++){B=A[t];if(B.indexOf(x)!==-1){v+=1}}}}}return v===w.length}}).call(this);